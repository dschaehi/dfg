\ProvidesPackage{proposal}[2025/08/03 v3.1.0 DFG Proposal Template]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DFG Proposal Style Package
% This package provides formatting and functionality for DFG grant proposals.
% Based on the official DFG guidelines for "Sachbeihilfe" grants.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%==============================================================================
% BASIC CONFIGURATION
%==============================================================================

% --- Encoding and Language ---
\usepackage[utf8]{inputenc}                % Use UTF-8 encoding
\usepackage[ngerman,english]{babel}        % German and English language support

% --- Fonts and Typography ---
\usepackage{helvet}                        % Use Helvetica font
\renewcommand{\familydefault}{\sfdefault}  % Set sans-serif as default
\usepackage[final]{microtype}              % Improved typography

%==============================================================================
% SCIENTIFIC CONTENT SUPPORT
%==============================================================================

% --- Math and Units ---
\usepackage{amsmath}                       % Enhanced math support
\usepackage[exponent-product=\cdot]{siunitx} % SI units with proper formatting
\sisetup{detect-all=true,locale=US}        % SIunitx configuration
% --- Figures and Graphics ---
\usepackage[dvipsnames,svgnames]{xcolor}   % Extended color support
\usepackage{graphicx}                      % Graphics inclusion
\graphicspath{{figures/}}                  % Default path for figures
\usepackage{tikz}                          % TikZ for vector graphics

% --- Tables and Captions ---
\usepackage{longtable}                     % Tables across multiple pages
\usepackage[font=small,
  labelfont={bf,it},
  textfont=it]{caption}          % Caption formatting
\captionsetup{format=plain}                % Simple caption style

%==============================================================================
% PAGE LAYOUT AND STRUCTURE
%==============================================================================

% --- Page Layout ---
% Following DFG margin requirements: https://github.com/hoelzer/dfg/issues/56
\usepackage[headheight=1cm,
  tmargin=2.5cm,
  lmargin=2.5cm,
  rmargin=2cm,
  bmargin=1.5cm]{geometry}       % Page geometry settings

% --- Document Structure ---
\usepackage{scrlayer-scrpage}              % KOMA-Script page style
\KOMAoptions{paper=a4}                     % A4 paper size
\KOMAoption{fontsize}{11pt}                % 11pt base font size
\usepackage[pagecontinue=false]{pageslts}

% --- Headings and Sections ---
\pagestyle{scrheadings}
\setkomafont{section}{\normalsize}         % Section font size
\setkomafont{subsection}{\normalsize}      % Subsection font size
\renewcommand{\headfont}{\sffamily\footnotesize} % Header font
\setlength{\parskip}{0.5em}                % Paragraph spacing
\setlength{\parindent}{0em}                % No paragraph indentation
\ohead*{\pagemark}                         % Page number in outer header
\cfoot*{}                                  % No footer
\chead{}                                   % No center header
\renewcommand{\pagemark}{page \thepage~of \lastpageref{pagesLTS.\pagenumtype}}
%==============================================================================
% REFERENCES AND HYPERLINKS
%==============================================================================

% --- Bibliography ---
\usepackage[backend=biber]{biblatex}       % Bibliography management
\addbibresource{literature.bib}            % Default bibliography file
\AtBeginBibliography{\small}               % Smaller font for bibliography

% --- Hyperlinks and PDF Properties ---
\usepackage[pdftex,
  colorlinks=true,
  linkcolor=MidnightBlue,
  citecolor=MidnightBlue,
  urlcolor=MidnightBlue,
  pdfauthor={},                  % Set author in main document
  pdfpagelayout=SinglePage,
  bookmarks,
  bookmarksopen]{hyperref}       % PDF hyperlinks and metadata

\usepackage[numbered]{bookmark}            % Numbered PDF bookmarks
\usepackage[noabbrev]{cleveref}            % Intelligent cross-referencing

%==============================================================================
% ADDITIONAL FUNCTIONALITY
%==============================================================================

% --- Utilities ---
\usepackage{silence}                       % Suppress specific package info messages
\WarningsOff[pageslts]                     % Mute pageslts informational messages
\usepackage{csquotes}                      % Context-sensitive quotation marks
\usepackage{eurosym}                       % Euro symbol
\usepackage{fp}                            % Fixed-point arithmetic
\usepackage{xspace}                        % Intelligent spacing
\usepackage{verbatim}                      % Verbatim text
\usepackage{ifthen}                        % Conditional processing

% --- Page Numbering ---
\pagenumbering{arabic}                     % Default to arabic numbers
\newcommand{\pagenumtype}{arabic}          % Track page numbering type

% --- Typography Improvements ---
% Avoid widows and orphans
\clubpenalty=10000
\widowpenalty=10000
\displaywidowpenalty=10000

% Reduce underfull hbox warnings
\tolerance=3000
\emergencystretch=15pt
\hbadness=2000
\hyphenpenalty=3000
\doublehyphendemerits=10000

%==============================================================================
% CUSTOM COMMANDS AND ENVIRONMENTS
%==============================================================================

% --- Funds Calculation ---
% Environment for calculating and displaying funding totals
\newcommand{\total}{Total}
\newenvironment{funds}[1][]
{\def\funds{0.00} \newcommand{\totaldescr}{#1}}
{\rule{\textwidth}{0.5pt} \par \total~\totaldescr \hfill \num[round-mode=places,round-precision=2]{\funds}\,\euro}

% Add a single funding position
\newcommand{\position}[2]{%
  \par #1 \hfill \num[round-mode=places,round-precision=2]{#2}\,\euro
  \FPeval{\funds}{\funds + #2}%
}

% Add a multiplied funding position (e.g., 3 × 1000€)
\newcommand{\positionmul}[3]{%
  \par #1 \hfill \num{#3} $\times$ \num[round-mode=places,round-precision=2]{#2}\,\euro
  \FPeval{\funds}{\funds + #3*#2}%
}

% --- Document Structure ---
\newcommand{\mainmatter}{%
  \cleardoublepage
  \pagestyle{plain}
}
% Switch to Roman page numbering for appendices
\newcommand{\backmatter}{%
  \clearpage
  \pagenumbering{Roman}
  \renewcommand{\pagenumtype}{Roman}%
  % Only include section, subsection, and paragraph for numbering
  \renewcommand{\theparagraph}{\thesubsubsection.\arabic{paragraph}}%
  \setcounter{secnumdepth}{5}
}
\newcommand{\makeprojecttitle}{%
  {\raggedright{} \normalsize \bfseries
      Project Description -- Project Proposals\todof{Sections 1--3 must not exceed 17 pages in total.} \par
      \applicants{} \par
      \project{} \par
      \rule{\textwidth}{0.5pt} \par
    }
}
% Add support for subsubsubsections (paragraph level with heading)
\newcommand{\subsubsubsection}[1]{\paragraph{#1} \mbox{} \par}

% --- Custom Paragraph Styles ---
\newcommand{\workpackagestyle}{%
  \setcounter{secnumdepth}{5}
  \RedeclareSectionCommand[
    beforeskip=-2.5ex plus-1ex minus -.2ex,
    afterskip=2.5ex plus 0.2ex minus 0.2ex]{paragraph}%
  \RedeclareSectionCommand[
    indent=0pt, beforeskip=-3.5ex plus-1ex minus -.2ex,
    afterskip=2.5ex plus 0.2ex minus 0.2ex]{subparagraph}
  \renewcommand{\theparagraph}{WP\arabic{paragraph}}%
}

\newcommand{\standardstyle}{%
  \setcounter{secnumdepth}{4}
  \RedeclareSectionCommand[
    beforeskip=3.25ex plus 1ex minus .2ex,
    afterskip=1.5ex plus .2ex]{paragraph}%
  \renewcommand{\theparagraph}{\thesection.\thesubsection.\thesubsubsection.\arabic{paragraph}}%
}